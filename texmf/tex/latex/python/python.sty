% based on xverbatim-sty
%
%modified by wanze   2013/12/15
%1.python3 mode


\NeedsTeXFormat{LaTeX2e}[1994/12/01]
\ProvidesPackage{python}[2013/11/21 v0.11  python3 mode]
\RequirePackage{fancyvrb}
\RequirePackage{verbatim}
\RequirePackage{color}

%Verbatim environment a little diy
\fvset{numbers=left,frame=lines,tabsize=4 ,baselinestretch=2,
    xleftmargin=6pt, fontsize=\footnotesize , numbersep=2pt}

\newwrite\@pyout
\newread\@pyretcode
% Put the  code in separate files.
\newcounter{@PythonEnvironmentCounter}
\setcounter{@PythonEnvironmentCounter}{0}

\newcounter{@ShowPythonCounter}%
\setcounter{@ShowPythonCounter}{1}

% open the file
\def\@openpy{%
%modified the code file name%
\def\@pyname{pyexport/\jobname
\ifnum\value{@PythonEnvironmentCounter}<10 0\fi
\ifnum\value{@PythonEnvironmentCounter}<100 0\fi
\arabic{@PythonEnvironmentCounter}}%
\immediate\openout\@pyout=\@pyname.pytemp%
}%

%here is hard to understand
\begingroup \catcode `|=0 \catcode `[=1
\catcode`]=2 \catcode `\{=12 \catcode `\}=12
\catcode`\\=12
|gdef|@python#1\end{python}[|immediate|write|@pyout[#1]|end[python]]
|endgroup


\DeclareRobustCommand*{\@showpy}{%
%use the pygmentize
\immediate\write18{pygmentize  -f tex -l python -o \@pyname.tex \@pyname.pytemp}
%use fancyvrb VerbatimInput control the out
\immediate\input{\@pyname.tex}
}

%environment start
\newenvironment{python}%
{
\immediate\stepcounter{@PythonEnvironmentCounter}
%if the filefolder doesnot exist  then creat it
\immediate\write18{if [  !  -d  pyexport/   ];  then mkdir -p pyexport/  ; fi}
\@openpy
\newlinechar='15
\begingroup \catcode`\^^M=12 %
\let\do\@makeother\dospecials\obeyspaces%
\@python}
  {\endgroup
  \immediate\closeout\@pyout
  \@showpy
}


\DeclareRobustCommand*\dopython[1]{%
\immediate\write18{ cd pyexport && cat *.pytemp >  #1.py  && mv  -f #1.py .. }
\immediate\write18{ gnome-terminal -e "python3 -i  #1.py"     }
\immediate\write18{ rm -rf pyexport   }%
}


\DeclareRobustCommand*\notdopython[1]{%
\immediate\write18{ cd pyexport && cat *.pytemp >  #1.py  && mv  -f #1.py .. }
\immediate\write18{ rm -rf pyexport   }%
}


\endinput
