% based on xverbatim-sty
%
%modified by wanze   2013/12/15
%1.python3 mode


\NeedsTeXFormat{LaTeX2e}[1994/12/01]
\ProvidesPackage{python}[2013/11/21 v0.1  python3 mode]
\RequirePackage{fancyvrb}
\RequirePackage{verbatim}
\RequirePackage{color}

%Verbatim environment a little diy
\fvset{numbers=left,frame=lines,tabsize=4 ,baselinestretch=2,
    xleftmargin=6pt, fontsize=\footnotesize , numbersep=2pt}

\newwrite\@pyout
\newread\@pyretcode
% Put the  code in separate files.
\newcounter{@PythonEnvironmentCounter}
\setcounter{@PythonEnvironmentCounter}{0}

\newcounter{@ShowPythonCounter}%
\setcounter{@ShowPythonCounter}{1}

% open the file
\def\@openpy{%
%modified the code file name%
\def\@pyname{pyexport/\jobname
\ifnum\value{@PythonEnvironmentCounter}<10 0\fi
\ifnum\value{@PythonEnvironmentCounter}<100 0\fi
\arabic{@PythonEnvironmentCounter}}%
\immediate\openout\@pyout=\@pyname.pytemp%
}%

%here is hard to understand
\begingroup \catcode `|=0 \catcode `[=1
\catcode`]=2 \catcode `\{=12 \catcode `\}=12
\catcode`\\=12
|gdef|@python#1\end{python}[|immediate|write|@pyout[#1]|end[python]]
|endgroup


\DeclareRobustCommand*{\@showpy}{%
%use the pygmentize
\immediate\write18{pygmentize  -f tex -l python -o \@pyname.tex \@pyname.pytemp}
%use fancyvrb VerbatimInput control the out
\immediate\input{\@pyname.tex}
}

%environment start
\newenvironment{python}%
{
\immediate\stepcounter{@PythonEnvironmentCounter}
%if the filefolder doesnot exist  then creat it
\immediate\write18{if [  !  -d  pyexport/   ];  then mkdir -p pyexport/  ; fi}
\@openpy
\newlinechar='15
\begingroup \catcode`\^^M=12 %
\let\do\@makeother\dospecials\obeyspaces%
\@python}
  {\endgroup
  \immediate\closeout\@pyout
  \@showpy
}

%error and rc
\DeclareRobustCommand*{\@writefeedback}{%
\immediate\openin\@pyretcode=\jobname.rc
\immediate\read\@pyretcode to \rc
\immediate\closein\@pyretcode

\ifnumequal{\rc}{0}{}{%
    \begingroup
        \color{red}
        \verbatiminput{\jobname-\arabic{@ShowPythonCounter}.py.err}
    \endgroup
}}

\DeclareRobustCommand*{\@showresult}{%
\begingroup
\obeylines
\parindent=0pt
\immediate\input{\jobname-\arabic{@ShowPythonCounter}.py.out}
\endgroup}


\DeclareRobustCommand*{\@executepy}{%
\immediate\write18{cat \jobname-\arabic{@ShowPythonCounter}.py |  /usr/bin/env python3 > \jobname-\arabic{@ShowPythonCounter}.py.out 2> \jobname-\arabic{@ShowPythonCounter}.py.err; echo -n $? > \jobname.rc}}


\DeclareRobustCommand*\dopython{% close the file
\immediate\write18{ cd pyexport && cat *.pytemp >  \jobname-\arabic{@ShowPythonCounter}.py  && mv \jobname-\arabic{@ShowPythonCounter}.py .. }
\@executepy
\@writefeedback
\@showresult
\stepcounter{@ShowPythonCounter}%

\immediate\write18{  rm -f  \jobname.rc }

}


\endinput
